{
  "description": "Before provisioning rule operations for HPHC-Salesforce.",
  "type": "BeforeProvisioning",
  "signature": {
    "input": [],
    "output": null
  },
  "sourceCode": {
    "version": "2022-12-01 20:40:02",
    "script": "\n\n    import sailpoint.object.ProvisioningPlan;\n    import sailpoint.object.Attributes;\n    import sailpoint.object.Identity;\n    import sailpoint.object.ProvisioningPlan.AccountRequest;\n    import sailpoint.object.ProvisioningPlan.AttributeRequest;\n    import sailpoint.object.ProvisioningPlan.Operation;\n    import sailpoint.object.ManagedAttribute;\n    import sailpoint.object.ManagedAttribute.Type;\t\t\n    import sailpoint.object.Filter;\n    import sailpoint.object.*;\n    import java.util.ArrayList;\n    import sailpoint.rule.ManagedAttributeDetails;\n    import sailpoint.tools.Util;\n    import java.util.Date;\n    import java.text.SimpleDateFormat;\n    import java.util.List;\n    import sailpoint.rule.Account;\n    \n    public AttributeRequest newAttributeRequest(String attributeName, Object attributeValue) \n    {\n      AttributeRequest attributeRequest = new ProvisioningPlan.AttributeRequest();\n      attributeRequest.setName(attributeName);\n      attributeRequest.setOperation(ProvisioningPlan.Operation.Set);\n      attributeRequest.setValue(attributeValue);\n      return attributeRequest;\n    }\n\n    public AttributeRequest newAttributeRequestRemove(String attributeName) {\n      AttributeRequest attributeRequest = new ProvisioningPlan.AttributeRequest();\n      attributeRequest.setName(attributeName);\n      attributeRequest.setOperation(ProvisioningPlan.Operation.Remove);\n      return attributeRequest;\n    }\n    \n    if(plan != null) {\n        Identity identity = plan.getIdentity();\n        String lifecycleState = null;\n        String accreq_role = null;\n        String accreq_permissionSet = null; \n        String accreq_managedPackage = null;\n        String profile = null;\n        String role = null;\n        String nativeId = null;\n        String ACCESS_REQUEST_MAPPING = \"HPHC Salesforce Access Request [source]\";\n        if(identity != null) {\n            List accountRequests = plan.getAccountRequests();\n            lifecycleState = identity.getAttribute(\"cloudLifecycleState\");\n            if(accountRequests != null && !accountRequests.isEmpty()) {\n                for(AccountRequest accountRequest : accountRequests) {\n                    AccountRequest.Operation op = accountRequest.getOperation();\n                    String nativeIdentity = accountRequest.getNativeIdentity();\n                    if(op == null) continue;\n                    if(op == AccountRequest.Operation.Create || op == AccountRequest.Operation.Modify) {\n                        List attReqs = accountRequest.getAttributeRequests();\n                        \n                        if(accountRequest.getAttributeRequests() != null && !attReqs.isEmpty()) {\n\n                            //get access request information\n                            for (ProvisioningPlan.AttributeRequest attributeReq: attReqs) {\n\n                                String name = attributeReq.getName();\n                                if ( name.equalsIgnoreCase(\"ProfileId\") ){\n                                    String ProfileAttrValue = (String) attributeReq.getValue();\n                                    ManagedAttributeDetails managedAttributeDetails = idn.getManagedAttributeDetails(application.getId(), \"ProfileId\", ProfileAttrValue, Type.Entitlement);\n                                \n                                    if (managedAttributeDetails == null)\n                                    throw new Exception(\" managed attribute per [\"+ name + \",\" + value +\"]\");\n\n                                    Map madAttributes = managedAttributeDetails.getAttributes();\n\t\t\t\t\t\t\t        profile = (String) madAttributes.get(\"Name\");\n                                }\n                                if ( name.equalsIgnoreCase(\"Role\") ){\n                                    String RoleAttrValue = (String) attributeReq.getValue();\n                                    ManagedAttributeDetails managedAttributeDetails = idn.getManagedAttributeDetails(application.getId(), \"Role\", RoleAttrValue, Type.Entitlement);\n                                \n                                    if (managedAttributeDetails == null)\n                                    throw new Exception(\" managed attribute per [\"+ name + \",\" + value +\"]\");\n\n                                    Map madAttributes = managedAttributeDetails.getAttributes();\n\t\t\t\t\t\t\t        role = (String) madAttributes.get(\"Name\");\n                                }\n                            }\n                        }\n                        if(profile!=null){\n                            nativeId = profile + \"|\" + role;\n                        \n                        Account account = idn.getAccountByNativeIdentity(ACCESS_REQUEST_MAPPING,nativeId);\n                        if(account != null){\n\n                            List managedPackageValues = new ArrayList();\n\n                            //get mapping information from delimited source\n                            accreq_managedPackage = idn.getAccountAttribute(account, \"ManagedPackage\");\n                            accreq_permissionSet = idn.getAccountAttribute(account, \"PermissionSet\");\n                            accreq_role = idn.getAccountAttribute(account, \"Role\");\n                            String CallCenterId = idn.getAccountAttribute(account, \"CallCenterId\");\n                            String accreq_userPermissionsMarketingUser = idn.getAccountAttribute(account, \"UserPermissionsMarketingUser\");\n                        \n\n                             //add attribute requests according to mapping\n                            if(accreq_role==null){\n                                accountRequest.add(newAttributeRequest(\"Role\", \"\"));\n                            }\n                            if(accreq_permissionSet==null){\n                                accountRequest.add(newAttributeRequest(\"PermissionSet\", \"\"));\n                            }\n                            \n                            String[] lines = accreq_managedPackage.split(\"\\\\|\");\n                            \n                            for (int i=0;i<lines.length; i++) {\n                                managedPackageValues.add(lines[i].replaceAll(\"[^a-zA-Z0-9]\", \"\"));\n                            }\n                            \n                            accountRequest.add(newAttributeRequest(\"ManagedPackage\", (managedPackageValues instanceof List ? (List) managedPackageValues : (String) managedPackageValues)));\n\n                            accountRequest.add(newAttributeRequest(\"UserPermissionsMarketingUser\", accreq_userPermissionsMarketingUser));\n                            accountRequest.add(newAttributeRequest(\"CallCenterId\", CallCenterId));\n                            \n                            //if requested role is System Administrator Integrations|Admin remove federation id request\n                            if(nativeId.equalsIgnoreCase(\"System Administrator Integrations|Admin\")){\n                                accountRequest.add(newAttributeRequestRemove(\"FederationIdentifier\"));\n                            }\n                        }\n                        }\n                    }\n                    else if( op == AccountRequest.Operation.Disable && \"inactive\".equals(lifecycleState) && nativeIdentity != null){\n                        accountRequest.add(newAttributeRequest(\"ManagedPackage\", \"\"));\n                    }\n                }\n            }\n        }\n    }\n"
  },
  "attributes": {
    "sourceVersion": "2022-12-01 20:40:02"
  },
  "id": "b9a12caa1e574527a7f970d1954be4e1",
  "name": "HPHC-Salesforce BeforeProvisioning",
  "created": "2022-11-15T18:46:04.543Z",
  "modified": "2024-04-17T19:16:03.994Z"
}