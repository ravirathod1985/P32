{
  "description": "Before provisioning rule operations for OHI WebService Source.",
  "type": "BeforeProvisioning",
  "signature": {
    "input": [],
    "output": null
  },
  "sourceCode": {
    "version": "2022-12-01 00:19:27",
    "script": "\nimport sailpoint.object.*;\nimport sailpoint.object.ProvisioningPlan.AccountRequest;\nimport sailpoint.object.ProvisioningPlan.AttributeRequest;\nimport sailpoint.tools.Util;\nimport java.util.Date;\nimport java.util.Calendar;\nimport java.lang.String;\nimport java.util.Arrays;\nimport java.util.ArrayList;\nimport java.util.List;\nimport java.text.SimpleDateFormat;\nimport sailpoint.rule.Account;\n\npublic AttributeRequest newAttributeRequest(String attributeName, Object attributeValue) \n{\n  AttributeRequest attributeRequest = new ProvisioningPlan.AttributeRequest();\n  attributeRequest.setName(attributeName);\n  attributeRequest.setOperation(ProvisioningPlan.Operation.Set);\n  attributeRequest.setValue(attributeValue);\n  return attributeRequest;\n}\n\nif(plan != null) {\n    Identity identity = plan.getIdentity();\n    String lifecycleState = null;\n\n    // Get the identity from the plan and perform operations\n    if(identity != null) {\n\n        List accountRequests = plan.getAccountRequests();\n        lifecycleState = identity.getAttribute(\"cloudLifecycleState\");\n\n        if(accountRequests != null && !accountRequests.isEmpty()) {\n\n            for(AccountRequest accountRequest : accountRequests) {\n                AccountRequest.Operation op = accountRequest.getOperation();\n                String nativeIdentity = accountRequest.getNativeIdentity();\n \n \n                if( op == AccountRequest.Operation.Modify && nativeIdentity != null) {\n                    if(accountRequest.getAttributeRequest(\"userRoleList\") != null){\n                        AttributeRequest userRoleListRequest = accountRequest.getAttributeRequest(\"userRoleList\");\n                        Object userRoles = userRoleListRequest.getValue();\n                        log.info(\"OHI BP Rule - ProvisioningPlan userRoleListRequests to be added/removed is: \" + userRoles);\n                        \n                        if(userRoleListRequest != null && userRoleListRequest.getOperation().equals(ProvisioningPlan.Operation.Remove)){\n                            Account account = idn.getAccountByNativeIdentity(application.getName(), nativeIdentity);\n                            if (account != null){\n                                List oldUserRoleList = (List) idn.getRawAccountAttribute(account,\"userRoleList\");\n                                log.info(\"OHI BP Rule - ProvisioningPlan userRoleList to be removed is: \" + userRoles + \"[OHI_PROV] Remove Entitlement Operation.\");\n\n                                if(userRoles instanceof String ){\n                                \toldUserRoleList.remove(userRoles);\n                                }else {\n                                \toldUserRoleList.removeAll(userRoles);\n                                }                                \n                                \n                                accountRequest.remove(userRoleListRequest);\n                                accountRequest.add(new AttributeRequest(\"userRoleList\", ProvisioningPlan.Operation.Add, oldUserRoleList));\n                                log.info(\"OHI BP Rule - Revised UserRoleList Value is: \"+ oldUserRoleList +\" for Identity - \"+ identity.getName() +\" :: [OHI_PROV] Remove Entitlement Operation\");\n                            }\n                        }\n                        \n                        if(userRoleListRequest != null && userRoleListRequest.getOperation().equals(ProvisioningPlan.Operation.Add)){\n                            Account account = idn.getAccountByNativeIdentity(application.getName(), nativeIdentity);  \n                            if (account != null){\n                                List oldUserRoleList = (List) idn.getRawAccountAttribute(account,\"userRoleList\");\n                                log.info(\"OHI BP Rule - ProvisioningPlan userRoleList to be Added is: \" + userRoles + \"[OHI_PROV] Add Entitlement Operation.\");\n                                \n                                if(userRoles instanceof String){\n                                \toldUserRoleList.add(userRoles);\n                                }else {\n                                \toldUserRoleList.addAll(userRoles);\n                                }\n                                \n                                accountRequest.remove(userRoleListRequest);\n                                accountRequest.add(new AttributeRequest(\"userRoleList\", ProvisioningPlan.Operation.Add, oldUserRoleList));\n                                log.info(\"OHI BP Rule - Revised UserRoleList Value is: \"+ oldUserRoleList +\" for Identity - \"+ identity.getName() +\" :: [OHI_PROV] Add Entitlement Operation\");\n                            }    \n                        }\n                    }\n                }\n            }\n        }\n    }\n}\n"
  },
  "attributes": {
    "sourceVersion": "2022-12-01 00:19:27"
  },
  "id": "7c45917f8e3141aa9f9fb7e147353c5f",
  "name": "OHI BeforeProvisioning",
  "created": "2022-11-01T19:28:01.759Z",
  "modified": "2024-04-17T19:16:03.350Z"
}